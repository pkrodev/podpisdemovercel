<!-- templates/sign.html -->
<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Podpis PDF — {{ doc_id }}</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:14px}
    .topbar{position:sticky;top:0;background:#fff;padding:10px 0;border-bottom:1px solid #eee;z-index:10}
    button{padding:12px 14px;border-radius:12px;border:1px solid #111;background:#111;color:#fff;font-weight:700}
    button.secondary{background:#fff;color:#111}
    .hint{color:#666;margin:8px 0 0}
    .page{margin:18px 0}
    .wrap{position:relative;display:inline-block;max-width:100%}
    img.pdf{display:block;max-width:100%;height:auto;border:1px solid #eee;border-radius:12px}
    canvas.sig{
      position:absolute;left:0;top:0;
      touch-action:none; /* ważne na tablet */
    }
    .pagehead{display:flex;gap:10px;align-items:center;margin:0 0 10px}
    .status{margin-left:auto;color:#666;font-size:14px}
    .smallbtn{padding:10px 12px;border-radius:12px;border:1px solid #111;background:#fff;color:#111;font-weight:700}
  </style>
</head>
<body>
  <div class="topbar">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button id="submitBtn">Zapisz podpis i generuj PDF</button>
      <button class="secondary" id="clearAllBtn" type="button">Wyczyść wszystko</button>
      <span class="status" id="status">Gotowe</span>
    </div>
    <div class="hint">Rysuj palcem po dokumencie. Podpis zostanie nałożony na PDF (na każdej stronie osobno).</div>
  </div>

  {% for p in pages %}
    <div class="page" data-idx="{{ p.idx }}">
      <div class="pagehead">
        <strong>Strona {{ p.idx + 1 }}</strong>
        <button class="smallbtn clearBtn" type="button">Wyczyść stronę</button>
      </div>

      <div class="wrap">
        <img class="pdf" id="img-{{ p.idx }}" src="/render/{{ p.name }}" alt="page {{ p.idx+1 }}">
        <canvas class="sig" id="c-{{ p.idx }}"></canvas>
      </div>
    </div>
  {% endfor %}

<script>
(() => {
  const docId = "{{ doc_id }}";
  const statusEl = document.getElementById("status");
  const submitBtn = document.getElementById("submitBtn");
  const clearAllBtn = document.getElementById("clearAllBtn");

  const canvases = [];
  const ctxs = [];
  const dirty = []; // czy było rysowane na stronie

  function setStatus(txt) { statusEl.textContent = txt; }

  function setupOne(idx) {
    const img = document.getElementById(`img-${idx}`);
    const canvas = document.getElementById(`c-${idx}`);
    const pageEl = document.querySelector(`.page[data-idx="${idx}"]`);
    const clearBtn = pageEl.querySelector(".clearBtn");

    dirty[idx] = false;

    function resize() {
      // dopasuj canvas do rozmiaru wyświetlanego obrazka (CSS px)
      const rect = img.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;

      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";
      canvas.width = Math.round(rect.width * ratio);
      canvas.height = Math.round(rect.height * ratio);

      const ctx = canvas.getContext("2d");
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0); // rysujemy w CSS px
      ctx.lineWidth = 2.5;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "#000";
      ctxs[idx] = ctx;
    }

    function pos(e) {
      const r = canvas.getBoundingClientRect();
      return { x: e.clientX - r.left, y: e.clientY - r.top };
    }

    let drawing = false;
    let last = null;

    canvas.addEventListener("pointerdown", (e) => {
      drawing = true;
      canvas.setPointerCapture(e.pointerId);
      last = pos(e);
    });

    canvas.addEventListener("pointermove", (e) => {
      if (!drawing) return;
      const p = pos(e);
      const ctx = ctxs[idx];
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      last = p;
      dirty[idx] = true;
    });

    canvas.addEventListener("pointerup", () => { drawing = false; last = null; });
    canvas.addEventListener("pointercancel", () => { drawing = false; last = null; });

    clearBtn.addEventListener("click", () => {
      const ctx = ctxs[idx];
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      dirty[idx] = false;
    });

    // init po załadowaniu obrazka
    if (img.complete) resize();
    else img.addEventListener("load", resize);

    window.addEventListener("resize", resize);

    canvases[idx] = canvas;
  }

  // setup dla każdej strony
  document.querySelectorAll(".page").forEach(el => {
    const idx = parseInt(el.getAttribute("data-idx"), 10);
    setupOne(idx);
  });

  clearAllBtn.addEventListener("click", () => {
    canvases.forEach((c, i) => {
      if (!c) return;
      const ctx = ctxs[i];
      ctx.clearRect(0, 0, c.width, c.height);
      dirty[i] = false;
    });
  });

  submitBtn.addEventListener("click", async () => {
    submitBtn.disabled = true;
    setStatus("Wysyłanie…");

    try {
      // wysyłamy tylko strony, na których coś narysowano
      const pages = [];
      canvases.forEach((c, i) => {
        if (!c) return;
        if (!dirty[i]) return;

        // UWAGA: toDataURL w rozdzielczości aktualnego canvas (DPR)
        pages.push({ index: i, dataURL: c.toDataURL("image/png") });
      });

      if (pages.length === 0) {
        setStatus("Brak podpisu — narysuj coś i spróbuj ponownie.");
        submitBtn.disabled = false;
        return;
      }

      setStatus("Generowanie PDF…");
      const res = await fetch(`/api/sign/${docId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pages })
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error(t || "Błąd serwera");
      }

      const data = await res.json();
      setStatus("Gotowe. Przekierowanie…");
      window.location.href = data.success_url;
    } catch (err) {
      console.error(err);
      setStatus("Błąd: " + (err?.message || err));
      submitBtn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
